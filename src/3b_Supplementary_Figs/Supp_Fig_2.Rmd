---
title: "Supp_Fig_2"
author: "Alecia-Jane Twigger"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

**Setting up**

*Load data and packages*
Firstly we must load the important libraries and then the data.
```{r, message=FALSE}
#load libraries
library(plyr)
library(dplyr)
library(scater)
library(RColorBrewer)
library(pheatmap)

##load data
sce <- readRDS("../../data/sce_all_nospike_2.rds")
ClustCol <- as.data.frame(read.csv("../../data/Clusters_noSpike_2.csv",stringsAsFactors = FALSE))

pD <- as.data.frame(colData(sce))

#order samples in a particular order
pD.ord <- group_by(pD, Sample) %>%
        ungroup(Sample) %>%
  mutate(Sample=forcats::fct_relevel(Sample, c("HMC1", "HMC2", "HMC3","HMC4", "HMC9", "HMC2B","HMC5","HMC6","HMC7","HMC8","RB1", "RB2","RB3","RB4","RB8","RB5","RB6","RB7"))) %>%
        arrange(Sample)
```
*Check that the data is loaded correctly*
```{r}
sce
```
*Load sample colours*
```{r}
sample.set <- c("HMC1", "HMC2", "HMC3","HMC4", "HMC2B","HMC5","HMC6","HMC7","HMC8", "HMC9","RB1", "RB2","RB3","RB4","RB5","RB6","RB7", "RB8")
colour.names <- c("salmon1", "peachpuff2", "burlywood", "#F8766D","peachpuff3", "salmon2", "pink1",  "indianred2", "indianred4", "hotpink2", "steelblue3", "slategray3", "paleturquoise3","#00BFC4","turquoise", "turquoise4", "lightblue1", "lightskyblue2")
```
**Supplementary Fig 2a**
*Extracting the cell count for each cell type*
```{r}
sumry <- group_by(pD, Sample) %>%
    summarize("Number of cells"=n(),
              "UMI"=mean(sum),
              "Genes"=mean(detected),
              "%Mito"=mean(subsets_Mito_percent))
kable(sumry,caption="Summary of cluster content")

write.csv(sumry,file="../../data/Supp_Fig_2/SummaryStatistics_bySample.csv",row.names=FALSE)
```
**Supplementary Fig 2b**
*Violin plot of UMI/cell per sample*
```{r}
LibrarySize <- ggplot(pD.ord, aes(x=Sample,y=sum, fill=Sample)) +
    geom_violin(draw_quantiles=0.5)+
    scale_y_log10() +
    ylab("Total number of molecules") +
    ggtitle("Number of Molecules") +
    theme_bw() + scale_fill_manual(values=setNames(colour.names, sample.set)) +
    theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
LibrarySize
pdf("../../data/Supp_Fig_2/UMI_counts.pdf", width=12, height=8)
LibrarySize
dev.off()
```
**Supplementary Fig 2c**
*Violin plot of genes/cell per sample*
```{r}
genesDetected <- ggplot(pD.ord, aes(x=Sample, y=detected, fill=Sample)) +
  geom_violin(draw_quantiles=0.5) +
  scale_y_log10() +
  ylab("Total number of genes detected") +
  ggtitle("Number of genes detected") +
  theme_bw() + scale_fill_manual(values=setNames(colour.names, sample.set)) +
    theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
genesDetected
pdf("../../data/Supp_Fig_2/Gene_count.pdf", width=12, height=8)
genesDetected
dev.off()
```
**Supplementary Fig 2d**
*Scatterplot of % mitochondrial genes and number of genes per cell coloured by sample*
```{r}
MitoUMI <- ggcells(sce, aes(x=subsets_Mito_percent, y=sum))+
    geom_point(aes(shape=factor(State), colour=Sample), alpha=1/2) +
    xlab("Percentage of mitochondrial reads") +
    ggtitle("%Mito vs. UMIs") + scale_color_manual(values=setNames(colour.names, sample.set)) +
    theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
MitoUMI
pdf("../../data/Supp_Fig_2/Mitocounts_vs_UMIs_sample.pdf", width=12, height=8)
```
**Supplementary Fig 2e**
*Principle component analysis of cells colored by sample*
```{r}
PCA12 <- ggcells(sce, mapping=aes(x=PCA1, y=PCA2, color=Sample)) + 
    geom_point() + scale_color_manual(values=setNames(colour.names, sample.set)) +
    theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
PCA12
pdf("../../data/Supp_Fig_2/PCA_1_2_Sample.pdf", width=12, height=8)
PCA12
dev.off()
```
*Saving session info*
```{r}
sessionInfo()
```
